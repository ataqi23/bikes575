---
title: 'Lab Report 3: Multiple Linear Regression'
subtitle: "MA 575 Fall 2021 - C3 Team #2"
author: "Ali Taqi, Hsin-Chang Lin, Huiru Yang, Ryan Mahoney, Yulin Li"
date: "11/15/2021"
output: 
  pdf_document: 
    toc: true
    number_sections: true
---

# Introduction 

In this lab report, Multiple Linear Regression (MLR) is performed on one response variable and a subset of predictors chosen from the 2011-2012 Bike Sharing dataset $^{[1]}$. The dataset contains three main kinds of response variables of our concerns: 

1. the count of **daily** bike rentals 
2. the count of **hourly** bike rentals. 

Within each kind of bike rental counts, the following 3 categories of rental counts are recorded: 

1. the count of bike rentals by **casual** users
2. the count of bike rentals by **registered** users
3. the **total** count, which is the sum of casual count and registered count. 

For simplicity, the **total** count of **daily** bike rentals is chosen as the response variable to be studied in this lab. The model should thus help answer the following question as mentioned in Lab Report 1: 

- What are the **daily** bike rentals under different conditions? (Business owners may like to know the daily bike rentals in 2013 so that they could optimize the inventory to reduce costs, and they may also wonder whether it is worth leaving the bike-sharing system open on days with extreme weather conditions. This can be done by performing predictive modeling on the daily rental variable based on data given in 2011 and 2012.)




# Preprocessing

## Overview

**Variable Interpretations** (see $[1]$)

Both hour.csv and day.csv have the following fields, except `hr` which is not available in bike-day.csv:
	
- `instant`: record index
- `dteday`: date
- `season`: season (1:spring, 2:summer, 3:fall, 4:winter)
- `yr`: year (0:2011, 1:2012)
- `mnth`: month ( 1 to 12)
- `hr`: hour (0 to 23)
- `holiday`: weather day is holiday or not (extracted from http://dchr.dc.gov/page/holiday-schedule)
- `weekday`: day of the week
- `workingday`: if day is neither weekend nor holiday is 1, otherwise is 0.
+ `weather-sit`: 
	- 1: Clear, Few clouds, Partly cloudy, Partly cloudy
	- 2: Mist + Cloudy, Mist + Broken clouds, Mist + Few clouds, Mist
	- 3: Light Snow, Light Rain + Thunderstorm + Scattered clouds, Light Rain + Scattered clouds
	- 4: Heavy Rain + Ice Pallets + Thunderstorm + Mist, Snow + Fog
- `temp`: Normalized temperature in Celsius. The values are divided to 41 (max)
- `atemp`: Normalized feeling temperature in Celsius. The values are divided to 50 (max)
- `hum`: Normalized humidity. The values are divided to 100 (max)
- `windspeed`: Normalized wind speed. The values are divided to 67 (max)
- `casual`: count of casual users
- `registered`: count of registered users
- `cnt`: count of total rental bikes including both casual and registered

$$ $$

```{r message=FALSE, warning=FALSE, include=FALSE}
# Load libraries
library(ggplot2)
library(GGally)
library(cowplot)
library(tidyverse)

# For ggplot, center all titles
theme_update(plot.title = element_text(hjust = 0.5))
```


```{r message=FALSE, warning=FALSE, include=FALSE}
# Read data
bikedata <- read.csv("../data/bike-day.csv",header=T)
```

```{r paged.print=TRUE}
# A brief look at the data structure from day.csv
head(bikedata, 3)
```


$$ $$

## Data Type & Value Conversion

```{r include=FALSE}
# Dates (from char to Date type)
dteday <- as.Date(bikedata$dteday)
```

Typically, all variables whose numerical values are not attached to actual physical meanings are treated as **categorical** variables.

```{r}
# Boolean variables (from int to logical type)
holiday <- as.logical(bikedata$holiday)          #0 or 1
workingday <- as.logical(bikedata$workingday)    #0 or 1

# Other categorical variables (from int to factor type)
season <- as.factor(bikedata$season)             #1 to 4
yr <- as.factor(bikedata$yr)                     #0 to 1
mnth <- as.factor(bikedata$mnth)                 #1 to 12
weekday <- as.factor(bikedata$weekday)           #0 to 6
weathersit <- as.factor(bikedata$weathersit)     #1 to 4
```

**Note:** Although `weathersit` (weather type) is a categorical variable, its numerical value (from 1 to 4) actually indicates a gradual change in the level of suitability for outdoor activities - the larger the number, the worse the weather condition (i.e., more fogs/rains/snows, see "Variable Interpretations" above). 

$$ $$

Furthermore, the normalized weather condition measurements (see "Variable Interpretations" above) are also converted to their original values, so that the numerical values being used "make more sense" to us. This makes it easier for commonsense and real-life experience to be applied in later analysis. 

```{r}
# Re-scale the normalized measurements
temp <- bikedata$temp * 41
atemp <- bikedata$atemp * 50
hum <- bikedata$hum * 100
windspeed <- bikedata$windspeed * 67 
```

$$ $$

## Visualization

```{r include=FALSE}
data <- bikedata[, c(14:16)]
data <- data.frame(dteday, season, yr, mnth, holiday, weekday, workingday,
                   weathersit, temp, atemp, hum, windspeed, data)
```

$$ $$


### Pairwise Relationships

Generally speaking, people's bike rental behaviors should be related to all seasonal and environmental factors, since all of them may to some degree affect people's willingness and ability to perform outdoor activities like biking. Therefore, all predictors should be taken into consideration, at least at the beginning. 

Note the seasonal variables `weekday`, `workingday` and `holiday` can be viewed as roughly uncorrelated to all the environmental variables. Therefore, it would be fine to just have two separate pairs plots involving each of two uncorrelated groups of predictors, respectively (to reduce the number of variables in a single plot for better resolutions). Additionally, observe that the seasonal variables `season`, `yr` (year) and `mnth` (month) can be inferred from the variable `dteday` (day). Therefore, the two pairs plots can be made using variables grouped in the following way, to guarantee that all essential relationships can be seen in the plots: 

$$ $$

**Group 1: (Mainly) Environmental**

Predictors (all environmental variables plus date):

- `dteday` (date)
- `weathersit` (weather type)
- `temp` (measured temperature)
- `atemp` (feeling temperature)
- `windspeed` (wind speed)
- `hum` (humidity)

Response:

- `cnt` (daily total count)

$$ $$

**Group 2: Seasonal**

Predictors (all seasonal variables):

- `dteday` (date)
- `season` (season)
- `yr` (year)
- `mnth` (month)
- `holiday` (holiday or not)
- `weekday` (day of the week)
- `workingday` (working day or not)

Response:

- `cnt` (daily total count)

$$ $$

#### Pairs Plot for Group 1 (Mainly Environmental)

$$\text{Fig.1: Pairs Plot for Group 1}$$

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggpairs(data[c('dteday','weathersit','temp','atemp','windspeed','hum','cnt')], 
        progress = F, 
        lower = list(continuous = wrap("points", alpha = 0.3, size=0.1))) + 
  theme_grey(base_size = 5.6) + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5))
```

Fig.1 Column names in order: 
`dteday`, `weathersit`, `temp`, `atemp`, `windspeed`, `hum`, `cnt`

$$ $$

**Observations:**

Looking at the last row of the pairs plot (Fig.1), only date and temperatures seem to be significant. The corresponding correlations are also the highest (see subplot 1, 3 & 4 on the last column of Fig.1), indicating that there should be some linear relationship to be explored. 

The two kinds of temperatures are highly correlated; to avoid co-linearity issues among the predictors in our model, only one of them should be kept. We choose to stick with the one having a higher correlation with rental counts, the feeling temperature, `atemp`.

Note that the significance of weather types is not immediately clear, since the distributions of rental counts under different weather types seem not to differ a lot (see subplot 2 on the last row of Fig.1), which is to our surprise. To take a closer look at the effect of weather types (`weathersit`), we choose to colored the pairs plot by it. 


$$\text{Fig.2: Pairs Plot for Group 1 (Colored by Weather Type)}$$

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggpairs(data[c('dteday','weathersit','temp','atemp','windspeed','hum','cnt')], 
        progress = F, 
        lower = list(continuous = wrap("points", alpha = 0.3, size=0.1)), 
        aes(colour=weathersit)) + 
  theme_grey(base_size = 5.6) + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5))
```
Fig.2 Column names in order: 
`dteday`, `weathersit`, `temp`, `atemp`, `windspeed`, `hum`, `cnt`

$$ $$

**Observations:**

From the first subplot on the last row of the above pairs plot (Fig.2), there does exist a separation of relatively higher and lower counts by weather type. This matches our commonsense - on more rainy days (weather type 2 & 3 indicated by the green and blue dots), people's biking activities do tend to less. This indicates that the weather type should be an useful predictor of bike rentals. 

However, the scatter plots of rental counts against temperatures (subplot 3 & 4 on the last row of Fig.2) are still not clearly separated by weather types, which is again to our surprise. Remember that from the previous lab report [2], we have observed in these scatter plots the clustering of data points roughly into three curves at different levels of rental counts, which made us suspect the need of some categorical variable to separate the data. Now that the weather type variable does not play the role, we should attempt some other categorical variables. 

After a few attempts, the desired categorical variable is found to be year, and the story starts to be clearer.  

$$\text{Fig.3: Pairs Plot for Group 1 (Colored by Year)}$$

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggpairs(data[c('dteday','weathersit','temp','atemp','windspeed','hum','cnt')], 
        progress = F, 
        lower = list(continuous = wrap("points", alpha = 0.3, size=0.1)), 
        aes(colour=yr)) + 
  theme_grey(base_size = 5.6) + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5))
```
Fig.3 Column names in order: 
`dteday`, `weathersit`, `temp`, `atemp`, `windspeed`, `hum`, `cnt`

$$ $$

From the scatter-plot matrices (Fig.1-3), a time correlation is already clear. In fact, it is almost the strongest pattern, indicating the necessity of a model involving time. Before a time-series model is studied in this course, such time correlation can be utilized by noting that rental counts in the same year generally differ from counts in the other years by a similar offset, and that, similarly, rental counts in the same months also generally differ from counts in the other months by a common offset. We can then include additive terms of the categorical variables `yr` (year) and `mnth` (month) to capture the time correlation. 

Furthermore, we should notice that the correlation of rental counts among different months have already been captured by another predictor, temperature. Also, the temperature variable must be highly correlated to the month variable. Then, to avoid co-linearity issues, only one of them can be kept, and in this case we should stick to temperature, because it better explains the nature of the underlying reason for that variation of bike rental counts: it is the body sensations instead of the number of months that ultimately affect people's willingness for outdoor activities. The same reasoning applies when comparing between the temperature variable and the season variable. 

$$ $$

**Conclusion:**

From the above reasoning, the predictors to be kept in this group of variables should be: 

- **'weathersit' (weather type)**
- **'atemp' (feeling temperature)**

The predictors `windspeed` (wind speed) and `hum` (humidity) should be dropped not only because they do not exhibit strong patterns and correlations with bike rental counts, but also because they both have a strong correlation with an existing predictor, 'weathersit' (weather type). 

$$ $$

#### Pairs Plot for Group 2 (Seasonal)

$$\text{Fig.4: Pairs Plot for Group 2}$$

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggpairs(data[c('dteday','season','yr','mnth','holiday','weekday','workingday', 'cnt')], 
        progress = F, 
        lower = list(continuous = wrap("points", alpha = 0.3, size=0.1))) + 
  theme_grey(base_size = 5.6) + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5))
```
Fig.4 Column names in order: 
`dteday`, `season`, `yr`, `mnth`, `holiday`, `weekday`, `workingday`, `cnt`


$$ $$

**Observations:**

Most predictors in this group are categorical. To see if they are useful / significant predictors, we mainly look at how large the differences are between the average response values within different categories. 

Looking at the last column of the pairs plot (Fig.4), significant predictors seem to include: 

- `dteday` (date)
- `season` (season)
- `yr` (year)
- `mnth` (month)
- `holiday` (holiday or not).

Surprisingly, the weekdays and working days do not seem influential, at least for now. 

Removing from the above list the variables that have strong correlations to the predictors already chosen from Group 1, we are left with the following predictors: 

- **`yr` (year)**
- **`holiday` (holiday or not)**.


$$ $$


### Time Variation

To further confirm the effect of the categorical variables `weekday` and `workingday`, we plot the rental counts by date and color the data points that are NOT working days (i.e., `workingday == FALSE`) (Fig.5,6), since that helps us identify the positions of weekends, which are included in non-working days, and thus we can infer from the plot where the other weekdays are. The holidays are also colored to help exclude the effect of holidays. 


$$ $$

**Observations:**

Zooming in (Fig.5,6), a phenomenon is observed: 

Many times, the rental count rises at the beginning of a week, reaches a maximum around the middle of the week and then falls down as the week approaches its end. This implies that the weekday variable could still be of some use. 

We choose to build our MLS model first with the chosen predictors from the previous sections, and see what difference the weekday and working-day predictors can made to that model afterwards.  

$$ $$

\newpage

$$\text{Fig.5: 2011 Total Count of Daily Bike Rentals by Date (with Trends)}$$

```{r fig.width=7, fig.height=4, echo=FALSE}
cols <- c('all day types' = "darkgrey", 'on non-working days' = "darkgreen", 'on holidays' = "red", 'trends' = 'black')

data2011 = data[data$dteday < '2012-01-01', ]

ggplot(data2011, aes(dteday, cnt, color = 'all day types')) + 
  geom_point(size = 1.5, pch = 20, alpha = 0.8) + 
  labs(x = 'Date', y = 'Daily Count') + 
  
  theme_grey(base_size = 5.6) + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5)) +
  
  geom_line(data2011, 
            mapping = aes(dteday, cnt, color = 'trends'), 
            size = 0.3, alpha = 0.8) + 

  geom_point(data2011[!(data2011$workingday), ], 
             mapping = aes(dteday, cnt, color = 'on non-working days'), 
             size = 1.5, pch = 16, alpha = 1) + 
  geom_point(data2011[data2011$holiday, ], 
             mapping = aes(dteday, cnt, color='on holidays'), 
             size = 1.5, pch = 16, alpha = 1) + 
  scale_color_manual(values = cols, 
                     labels = names(cols), 
                     name = 'Daily Count')
```

$$ $$

$$\text{Fig.6: 2012 Total Count of Daily Bike Rentals by Date (with Trends)}$$

```{r fig.width=7, fig.height=4, echo=FALSE}
cols <- c('all day types' = "darkgrey", 'on non-working days' = "darkgreen", 'on holidays' = "red", 'trends' = 'black')

data2012 = data[data$dteday >= '2012-01-01', ]

ggplot(data2012, aes(dteday, cnt, color = 'all day types')) + 
  geom_point(size = 1.5, pch = 20, alpha = 0.8) + 
  labs(x = 'Date', y = 'Daily Count') + 
  
  theme_grey(base_size = 5.6) + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5)) +
  
  geom_line(data2012, 
            mapping = aes(dteday, cnt, color = 'trends'), 
            size = 0.3, alpha = 0.8) + 

  geom_point(data2012[!(data2012$workingday), ], 
             mapping = aes(dteday, cnt, color = 'on non-working days'), 
             size = 1.5, pch = 16, alpha = 1) + 
  geom_point(data2012[data2012$holiday, ], 
             mapping = aes(dteday, cnt, color='on holidays'), 
             size = 1.5, pch = 16, alpha = 1) + 
  scale_color_manual(values = cols, 
                     labels = names(cols), 
                     name = 'Daily Count')
```


$$ $$

# Multiple Linear Regression (MLR) Modeling 

## Model Building

### Model 1: Linear in Temperature

```{r}
# MLR Model 1: Linear in Temperature
m.mlr.1 <- lm(cnt ~ yr + holiday + weathersit + atemp, data = bikedata)
summary(m.mlr.1)
```

$$ $$

### Model 2: Quadratic in Temperature

```{r}
# MLR Model 2: Quadratic in Temperature
m.mlr.2 <- lm(cnt ~ yr + holiday + weathersit + atemp + I(atemp^2), data = bikedata)
summary(m.mlr.2)
```

$$ $$

### Model 3: Cubic in Temperature

```{r}
# MLR Model 3: Cubic in Temperature
m.mlr.3 <- lm(cnt ~ yr + holiday + weathersit + atemp + I(atemp^2) + I(atemp^3), data = bikedata)
summary(m.mlr.3)
```

$$ $$

### MLR Model 4: Quartic in Temperature

```{r}
# MLR Model 4: Quartic in Temperature
m.mlr.4 <- lm(cnt ~ yr + holiday + weathersit + atemp + I(atemp^2) + I(atemp^3) + I(atemp^4), 
              data = bikedata)
summary(m.mlr.4)
```

$$ $$

The quartic model (Model 4) ends up having all temperature terms insignificant, presumably because the influence of each individual term in the polynomial are being evened out by other terms having a similar effect (e.g., the 4th order term is able to cover some variation in the form of a 3rd-order polynomial, and the linear term is similar to the 3rd-order term in that both functions are odd). 

We can verify this guess by removing one of the lower-order terms, say, the cubic term: 

$$ $$

```{r}
# MLR Model 4_1: Quartic in Temperature
m.mlr.4_1 <- lm(cnt ~ yr + holiday + weathersit + atemp + I(atemp^2) + I(atemp^4), 
                data = bikedata)
summary(m.mlr.4_1)
```

$$ $$

Alternatively, removing the quadratic term also does the job (actually even better):

$$ $$

```{r}
# MLR Model 4_2: Quartic in Temperature
m.mlr.4_2 <- lm(cnt ~ yr + holiday + weathersit + atemp + I(atemp^3) + I(atemp^4), 
                data = bikedata)
summary(m.mlr.4_2)
```

$$ $$

### MLR Model 3: Additional Models

Inspired by the result of the quartic models, we should also try removing one of the lower-order terms in the cubic model (Model 3): 

$$ $$

```{r}
# MLR Model 3_1: Cubic in Temperature (dropping one less-significant lower-order term)
m.mlr.3_1 <- lm(cnt ~ yr + holiday + weathersit + I(atemp^2) + I(atemp^3), 
                data = bikedata)
summary(m.mlr.3_1)
```

$$ $$

```{r}
# MLR Model 3_2: Cubic in Temperature (dropping another lower-order term)
m.mlr.3_2 <- lm(cnt ~ yr + holiday + weathersit + atemp + I(atemp^3), data = bikedata)
summary(m.mlr.3_2)
```

$$ $$

## Model Selection 

### Fitted Values

```{r echo=FALSE}
# Obtain the fitted values from the model
fitted_vals1   <- predict(m.mlr.1)
fitted_vals2   <- predict(m.mlr.2)
fitted_vals3   <- predict(m.mlr.3)
fitted_vals3_1 <- predict(m.mlr.3_1)
fitted_vals3_2 <- predict(m.mlr.3_2)
fitted_vals4   <- predict(m.mlr.4)
fitted_vals4_1 <- predict(m.mlr.4_1)
fitted_vals4_2 <- predict(m.mlr.4_2)

cols <- c('Linear' = "cyan", 'Quadratic' = "blue", 'Cubic' = "red", 'Quartic' = 'black')
```


```{r echo=FALSE}
# Plot the predicted values in 2011
p1 <- ggplot(data = data2011, aes(x = temp, y = cnt)) + 
  geom_point(size = 0.5, color = "deepskyblue4", alpha = 0.4) + 
  
  labs(x = "Temperature (ºC)", y = "Daily Count", 
       title = "Model 1") + 
  theme_grey(base_size = 5.6) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5)) + 
  
  geom_line(data = data2011, mapping = aes(x = temp, y = fitted_vals1[data$dteday < '2012-01-01'], col = names(cols)[1]), lwd = 1) +
  scale_color_manual(values = cols[1], 
                     labels = names(cols)[1], 
                     name = 'Prediction')

# Plot the predicted values
p2 <- ggplot(data = data2011, aes(x = temp, y = cnt)) + 
  geom_point(size = 0.5, color = "deepskyblue4", alpha = 0.4) + 
  
  labs(x = "Temperature (ºC)", y = "Daily Count", 
       title = "Model 2") + 
  theme_grey(base_size = 5.6) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5)) + 
  
  geom_line(data = data2011, mapping = aes(x = temp, y = fitted_vals2[data$dteday < '2012-01-01'], col = names(cols)[2]), lwd = 1) +
  scale_color_manual(values = cols[2], 
                     labels = names(cols)[2], 
                     name = 'Prediction')

# Plot the predicted values
p3 <- ggplot(data = data2011, aes(x = temp, y = cnt)) + 
  geom_point(size = 0.5, color = "deepskyblue4", alpha = 0.4) + 
  
  labs(x = "Temperature (ºC)", y = "Daily Count", 
       title = "Model 3") + 
  theme_grey(base_size = 5.6) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5)) + 
  
  geom_line(data = data2011, mapping = aes(x = temp, y = fitted_vals3[data$dteday < '2012-01-01'], col = names(cols)[3]), lwd = 1) +
  scale_color_manual(values = cols[3], 
                     labels = names(cols)[3], 
                     name = 'Prediction')

# Plot the predicted values
p3_1 <- ggplot(data = data2011, aes(x = temp, y = cnt)) + 
  geom_point(size = 0.5, color = "deepskyblue4", alpha = 0.4) + 
  
  labs(x = "Temperature (ºC)", y = "Daily Count", 
       title = "Model 3_1") + 
  theme_grey(base_size = 5.6) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5)) + 
  
  geom_line(data = data2011, mapping = aes(x = temp, y = fitted_vals3_1[data$dteday < '2012-01-01'], col = names(cols)[3]), lwd = 1) +
  scale_color_manual(values = cols[3], 
                     labels = names(cols)[3], 
                     name = 'Prediction')

# Plot the predicted values
p3_2 <- ggplot(data = data2011, aes(x = temp, y = cnt)) + 
  geom_point(size = 0.5, color = "deepskyblue4", alpha = 0.4) + 
  
  labs(x = "Temperature (ºC)", y = "Daily Count", 
       title = "Model 3_2") + 
  theme_grey(base_size = 5.6) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5)) + 
  
  geom_line(data = data2011, mapping = aes(x = temp, y = fitted_vals3_2[data$dteday < '2012-01-01'], col = names(cols)[3]), lwd = 1) +
  scale_color_manual(values = cols[3], 
                     labels = names(cols)[3], 
                     name = 'Prediction')

# Plot the predicted values
p4 <- ggplot(data = data2011, aes(x = temp, y = cnt)) + 
  geom_point(size = 0.5, color = "deepskyblue4", alpha = 0.4) + 
  
  labs(x = "Temperature (ºC)", y = "Daily Count", 
       title = "Model 4") + 
  theme_grey(base_size = 5.6) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5)) + 
  
  geom_line(data = data2011, mapping = aes(x = temp, y = fitted_vals4[data$dteday < '2012-01-01'], col = names(cols)[4]), lwd = 1) +
  scale_color_manual(values = cols[4], 
                     labels = names(cols)[4], 
                     name = 'Prediction')

# Plot the predicted values
p4_1 <- ggplot(data = data2011, aes(x = temp, y = cnt)) + 
  geom_point(size = 0.5, color = "deepskyblue4", alpha = 0.4) + 
  
  labs(x = "Temperature (ºC)", y = "Daily Count", 
       title = "Model 4_1") + 
  theme_grey(base_size = 5.6) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5)) + 
  
  geom_line(data = data2011, mapping = aes(x = temp, y = fitted_vals4_1[data$dteday < '2012-01-01'], col = names(cols)[4]), lwd = 1) +
  scale_color_manual(values = cols[4], 
                     labels = names(cols)[4], 
                     name = 'Prediction')

# Plot the predicted values
p4_2 <- ggplot(data = data2011, aes(x = temp, y = cnt)) + 
  geom_point(size = 0.5, color = "deepskyblue4", alpha = 0.4) + 
  
  labs(x = "Temperature (ºC)", y = "Daily Count", 
       title = "Model 4_2") + 
  theme_grey(base_size = 5.6) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5)) + 
  
  geom_line(data = data2011, mapping = aes(x = temp, y = fitted_vals4_2[data$dteday < '2012-01-01'], col = names(cols)[4]), lwd = 1) +
  scale_color_manual(values = cols[4], 
                     labels = names(cols)[4], 
                     name = 'Prediction')
```

$$\text{Fig.7: 2011 Daily Bike Usage Count by Feeling Temperature, Predictions Overlayed}$$

```{r fig.width=9, fig.height=6, echo=FALSE}
plot_grid(p1, p2, p3, p3_1, p3_2, p4, p4_1, p4_2)
```


```{r echo=FALSE}
# Plot the predicted values in 2012

cols <- c('Linear' = "cyan", 'Quadratic' = "blue", 'Cubic' = "red", 'Quartic' = 'black')

p1 <- ggplot(data = data2012, aes(x = temp, y = cnt)) + 
  geom_point(size = 0.5, color = "deepskyblue4", alpha = 0.4) + 
  
  labs(x = "Temperature (ºC)", y = "Daily Count", 
       title = "Model 1") + 
  theme_grey(base_size = 5.6) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5)) + 
  
  geom_line(data = data2012, mapping = aes(x = temp, y = fitted_vals1[data$dteday >= '2012-01-01'], col = names(cols)[1]), lwd = 1) +
  scale_color_manual(values = cols[1], 
                     labels = names(cols)[1], 
                     name = 'Prediction')

# Plot the predicted values
p2 <- ggplot(data = data2012, aes(x = temp, y = cnt)) + 
  geom_point(size = 0.5, color = "deepskyblue4", alpha = 0.4) + 
  
  labs(x = "Temperature (ºC)", y = "Daily Count", 
       title = "Model 2") + 
  theme_grey(base_size = 5.6) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5)) + 
  
  geom_line(data = data2012, mapping = aes(x = temp, y = fitted_vals2[data$dteday >= '2012-01-01'], col = names(cols)[2]), lwd = 1) +
  scale_color_manual(values = cols[2], 
                     labels = names(cols)[2], 
                     name = 'Prediction')

# Plot the predicted values
p3 <- ggplot(data = data2012, aes(x = temp, y = cnt)) + 
  geom_point(size = 0.5, color = "deepskyblue4", alpha = 0.4) + 
  
  labs(x = "Temperature (ºC)", y = "Daily Count", 
       title = "Model 3") + 
  theme_grey(base_size = 5.6) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5)) + 
  
  geom_line(data = data2012, mapping = aes(x = temp, y = fitted_vals3[data$dteday >= '2012-01-01'], col = names(cols)[3]), lwd = 1) +
  scale_color_manual(values = cols[3], 
                     labels = names(cols)[3], 
                     name = 'Prediction')

# Plot the predicted values
p3_1 <- ggplot(data = data2012, aes(x = temp, y = cnt)) + 
  geom_point(size = 0.5, color = "deepskyblue4", alpha = 0.4) + 
  
  labs(x = "Temperature (ºC)", y = "Daily Count", 
       title = "Model 3_1") + 
  theme_grey(base_size = 5.6) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5)) + 
  
  geom_line(data = data2012, mapping = aes(x = temp, y = fitted_vals3_1[data$dteday >= '2012-01-01'], col = names(cols)[3]), lwd = 1) +
  scale_color_manual(values = cols[3], 
                     labels = names(cols)[3], 
                     name = 'Prediction')

# Plot the predicted values
p3_2 <- ggplot(data = data2012, aes(x = temp, y = cnt)) + 
  geom_point(size = 0.5, color = "deepskyblue4", alpha = 0.4) + 
  
  labs(x = "Temperature (ºC)", y = "Daily Count", 
       title = "Model 3_2") + 
  theme_grey(base_size = 5.6) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5)) + 
  
  geom_line(data = data2012, mapping = aes(x = temp, y = fitted_vals3_2[data$dteday >= '2012-01-01'], col = names(cols)[3]), lwd = 1) +
  scale_color_manual(values = cols[3], 
                     labels = names(cols)[3], 
                     name = 'Prediction')

# Plot the predicted values
p4 <- ggplot(data = data2012, aes(x = temp, y = cnt)) + 
  geom_point(size = 0.5, color = "deepskyblue4", alpha = 0.4) + 
  
  labs(x = "Temperature (ºC)", y = "Daily Count", 
       title = "Model 4") + 
  theme_grey(base_size = 5.6) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5)) + 
  
  geom_line(data = data2012, mapping = aes(x = temp, y = fitted_vals4[data$dteday >= '2012-01-01'], col = names(cols)[4]), lwd = 1) +
  scale_color_manual(values = cols[4], 
                     labels = names(cols)[4], 
                     name = 'Prediction')

# Plot the predicted values
p4_1 <- ggplot(data = data2012, aes(x = temp, y = cnt)) + 
  geom_point(size = 0.5, color = "deepskyblue4", alpha = 0.4) + 
  
  labs(x = "Temperature (ºC)", y = "Daily Count", 
       title = "Model 4_1") + 
  theme_grey(base_size = 5.6) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5)) + 
  
  geom_line(data = data2012, mapping = aes(x = temp, y = fitted_vals4_1[data$dteday >= '2012-01-01'], col = names(cols)[4]), lwd = 1) +
  scale_color_manual(values = cols[4], 
                     labels = names(cols)[4], 
                     name = 'Prediction')

# Plot the predicted values
p4_2 <- ggplot(data = data2012, aes(x = temp, y = cnt)) + 
  geom_point(size = 0.5, color = "deepskyblue4", alpha = 0.4) + 
  
  labs(x = "Temperature (ºC)", y = "Daily Count", 
       title = "Model 4_2") + 
  theme_grey(base_size = 5.6) +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5)) + 
  
  geom_line(data = data2012, mapping = aes(x = temp, y = fitted_vals4_2[data$dteday >= '2012-01-01'], col = names(cols)[4]), lwd = 1) +
  scale_color_manual(values = cols[4], 
                     labels = names(cols)[4], 
                     name = 'Prediction')
```


Observe that in 2011 (Fig.7), all models have to some degree lead to predicted counts below 0. This is a problem that should be fixed.  

$$ $$
\newpage

$$\text{Fig.8: 2012 Daily Bike Usage Count by Feeling Temperature, Predictions Overlayed}$$


```{r fig.width=9, fig.height=6, echo=FALSE}
plot_grid(p1, p2, p3, p3_1, p3_2, p4, p4_1, p4_2)
```

Considering both the significance of coefficients and how well the visual trends are captured (Fig.7,8), we keep Model 2, 3_1 and 4_2 for further comparisons. 


## Residual Diagostics

### Residual Trends

$$\text{Fig.9: Standardized Residual Plots}$$

```{r fig.width=6, fig.height=2, echo=FALSE}
# Standardized Residuals vs Temperature
StanRes.2 <- rstandard(m.mlr.2)
data.mlr.2 <- data.frame(atemp,StanRes.2)

StanRes.3_1 <- rstandard(m.mlr.3_1)
data.mlr.3_1 <- data.frame(atemp,StanRes.3_1)

StanRes.4_2 <- rstandard(m.mlr.4_2)
data.mlr.4_2 <- data.frame(atemp,StanRes.4_2)

r2 <- ggplot() + 
  geom_point(data=data.mlr.2,   aes(x=atemp, y=StanRes.2,   color = names(cols[2])), size = 1) +
  geom_hline(yintercept=2,color='blue') + geom_hline(yintercept=-2, color='blue') +
  scale_color_manual(name = element_blank(), labels = names(cols[2]), values = cols[2]) +
  labs(x = "Temperature (ºC)", y = "Standarized Residual", title = "Model 2") + 
  theme_grey(base_size = 5.6) + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5))

r3_1 <- ggplot() + 
  geom_point(data=data.mlr.3_1, aes(x=atemp, y=StanRes.3_1, color = names(cols[3])), size = 1) +
  geom_hline(yintercept=2,color='blue') + geom_hline(yintercept=-2, color='blue') +
  scale_color_manual(name = element_blank(), labels = names(cols[3]), values = cols[3]) +
  labs(x = "Temperature (ºC)", y = "Standarized Residual", title = "Model 3_1") +
  theme_grey(base_size = 5.6) + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5))

r4_2 <- ggplot() + 
  geom_point(data=data.mlr.4_2, aes(x=atemp, y=StanRes.4_2, color = names(cols[4])), size = 1) +
  geom_hline(yintercept=2,color='blue') + geom_hline(yintercept=-2, color='blue') +
  scale_color_manual(name = element_blank(), labels = names(cols[4]), values = cols[4]) +
  labs(x = "Temperature (ºC)", y = "Standarized Residual", title = "Model 4_2") + 
  theme_grey(base_size = 5.6) + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5))


plot_grid(r2, r3_1, r4_2, ncol = 3)
```

Most data points spreed evenly above and below the x-axis, which means the predicted values have captured the correct trends in response variation, which is good. Note that for the quadratic model (Model 2), there is still a slight positive bias in the lower-temperature parts and a negative bias in the higher-temperature parts, which also matches our observation in Fig.7&8. This problem is alleviated in the higher-degree models. 

### Residual Normality

#### Standardized Residual versus Fitted Value

$$\text{Fig.10: Standardized Residual Plots}$$

```{r fig.width=6, fig.height=2, echo=FALSE}
# Standardized Residuals vs Fitted
data.mlr.2   <- data.frame(fitted_vals2,   StanRes.2)
data.mlr.3_1 <- data.frame(fitted_vals3_1, StanRes.3_1)
data.mlr.4_2 <- data.frame(fitted_vals4_2, StanRes.4_2)

r2 <- ggplot() + 
  geom_point(data=data.mlr.2,   aes(x=fitted_vals2, y=StanRes.2,   color = names(cols[2])), size = 1) +
  geom_hline(yintercept=2,color='blue') + geom_hline(yintercept=-2, color='blue') +
  scale_color_manual(name = element_blank(), labels = names(cols[2]), values = cols[2]) +
  labs(x = "Predicted Count", y = "Standarized Residual", title = "Model 2") + 
  theme_grey(base_size = 5.6) + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5))

r3_1 <- ggplot() + 
  geom_point(data=data.mlr.3_1, aes(x=fitted_vals3_1, y=StanRes.3_1, color = names(cols[3])), size = 1) +
  geom_hline(yintercept=2,color='blue') + geom_hline(yintercept=-2, color='blue') +
  scale_color_manual(name = element_blank(), labels = names(cols[3]), values = cols[3]) +
  labs(x = "Predicted Count", y = "Standarized Residual", title = "Model 3_1") + 
  theme_grey(base_size = 5.6) + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5))

r4_2 <- ggplot() + 
  geom_point(data=data.mlr.4_2, aes(x=fitted_vals4_2, y=StanRes.4_2, color = names(cols[4])), size = 1) +
  geom_hline(yintercept=2,color='blue') + geom_hline(yintercept=-2, color='blue') +
  scale_color_manual(name = element_blank(), labels = names(cols[4]), values = cols[4]) +
  labs(x = "Predicted Count", y = "Standarized Residual", title = "Model 4_2") + 
  theme_grey(base_size = 5.6) + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5))


plot_grid(r2, r3_1, r4_2, ncol = 3)
```

When the predicted counts are low, which corresponds to the lower-temperature parts in Fig.10, the residuals have a positive bias, i.e., the predicted values tend to be less than the true values, which matches what we have seen in Fig.7&8. 

The problem that the predicted rental counts go below 0 still needs to be fixed in the later studies. 

#### Normal Q-Q Plots

$$\text{Fig.11: Normal Q-Q Plots}$$

```{r fig.width=6, fig.height=2, echo=FALSE}
# QQ Plot
p2 <- ggplot(data.frame(StanRes.2), aes(sample = StanRes.2, color = names(cols[2]))) + 
  scale_color_manual(name = element_blank(), labels = names(cols[2]), values = cols[2]) + 
  stat_qq() + stat_qq_line() + 
  theme_grey(base_size = 5.6) + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5))

p3_1 <- ggplot(data.frame(StanRes.3_1), aes(sample = StanRes.3_1, color = names(cols[3]))) + 
  scale_color_manual(name = element_blank(), labels = names(cols[3]), values = cols[3]) + 
  stat_qq() + stat_qq_line() + 
  theme_grey(base_size = 5.6) + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5)) 

p4_2 <- ggplot(data.frame(StanRes.4_2), aes(sample = StanRes.4_2, color = names(cols[4]))) + 
  scale_color_manual(name = element_blank(), labels = names(cols[4]), values = cols[4]) + 
  stat_qq() + stat_qq_line() + 
  theme_grey(base_size = 5.6) + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5)) 

plot_grid(p2, p3_1, p4_2, ncol = 3)
```

All of the residual distributions (Fig.11) match quite well with the standard normal distribution, which is really great, as such degree of matches can rarely be seen in general. 

\newpage

#### Residual Histograms

$$\text{Fig.12: Residual Histograms}$$

```{r fig.width=6, fig.height=2, echo=FALSE}
# Histogram of Quadratic and QMLS

p2 <- ggplot(data.frame(StanRes.2), aes(x = StanRes.2, color = names(cols[2]))) + 
  scale_color_manual(name = element_blank(), labels = names(cols[2]), values = cols[2]) + 
  labs(x = "Standardized Residual", title = "Model 2") + 
  geom_histogram(bins = 100) + 
  theme_grey(base_size = 5.6) + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5))

p3_1 <- ggplot(data.frame(StanRes.3_1), aes(x = StanRes.3_1, color = names(cols[3]))) + 
  scale_color_manual(name = element_blank(), labels = names(cols[3]), values = cols[3]) + 
  labs(x = "Standardized Residual", title = "Model 3_1") + 
  geom_histogram(bins = 100) + 
  theme_grey(base_size = 5.6) + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5))

p4_2 <- ggplot(data.frame(StanRes.4_2), aes(x = StanRes.4_2, color = names(cols[4]))) + 
  scale_color_manual(name = element_blank(), labels = names(cols[4]), values = cols[4]) + 
  labs(x = "Standardized Residual", title = "Model 4_2") + 
  geom_histogram(bins = 100) + 
  theme_grey(base_size = 5.6) + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5))

plot_grid(p2, p3_1, p4_2, ncol = 3)
```

Given the nice match of distributions (Fig.11), the histograms should also match the standard normal distribution quite well, but surprisingly, the cubic model exhibits a slight bi-model issue (Fig.12). This is to be inspected in later analysis. 

# Conclusion

Given the above diagnostic results, it is still hard to decide among the 3 models. 

Model 2 is good in that it involves less higher order terms, which means more stability of the model. However, it is weak in that it does not fit as well under the lowest and highest temperatures. 

Model 3_1 and 4_2 are good in that they fit the best among all, have all coefficients significant, and also have nice diagnostic performance. However, the existence of higher-order terms leads to a more unstable model, and the one at a medium level of polynomial degrees, Model 3_1, happens to have the bi-modal issue in its standardized residuals.  

These problems could potentially be resolved by:

1. introducing a time-series model 
2. including the weekday variable
3. breaking the model into high and low temperature parts and model them separately. 

Further analysis is left for the next lab report. 


# References

[1] Fanaee-T, Hadi, and Gama, Joao, "Event labeling combining ensemble detectors and background knowledge", Progress in Artificial Intelligence (2013): pp. 1-15, Springer Berlin Heidelberg, doi:10.1007/s13748-013-0040-3.

[2] MA 575 Fall 2021 C3 Team #2, "Lab Report 2: Ordinary Least Squares".

\newpage

# Appendix: Intermediate Results

$$\text{Fig.13: Pairs Plot for Group 1 (Colored by Season)}$$

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggpairs(data[c('dteday','weathersit','temp','atemp','windspeed','hum','cnt')], 
        progress = F, 
        lower = list(continuous = wrap("points", alpha = 0.3, size=0.1)), 
        aes(colour=season)) + 
  theme_grey(base_size = 5.6) + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5))
```
Fig.13 Column names in order: 
`dteday`, `weathersit`, `temp`, `atemp`, `windspeed`, `hum`, `cnt`

$$ $$

\newpage

$$\text{Fig.14: Pairs Plot for Group 1 (Colored by Month)}$$

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggpairs(data[c('dteday','weathersit','temp','atemp','windspeed','hum','cnt')], 
        progress = F, 
        lower = list(continuous = wrap("points", alpha = 0.3, size=0.1)), 
        aes(colour=mnth)) + 
  theme_grey(base_size = 5.6) + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5))
```
Fig.14 Column names in order: 
`dteday`, `weathersit`, `temp`, `atemp`, `windspeed`, `hum`, `cnt`



$$ $$
\newpage

$$\text{Fig.15: Pairs Plot for Group 1 (Colored by Weekdays)}$$

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggpairs(data[c('dteday','weathersit','temp','atemp','windspeed','hum','cnt')], 
        progress = F, 
        lower = list(continuous = wrap("points", alpha = 0.3, size=0.1)), 
        aes(colour=weekday)) + 
  theme_grey(base_size = 5.6) + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5))
```
Fig.15 Column names in order: 
`dteday`, `weathersit`, `temp`, `atemp`, `windspeed`, `hum`, `cnt`



$$ $$
\newpage

$$\text{Fig.16: Pairs Plot for Group 1 (Colored by Working Day)}$$

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggpairs(data[c('dteday','weathersit','temp','atemp','windspeed','hum','cnt')], 
        progress = F, 
        lower = list(continuous = wrap("points", alpha = 0.3, size=0.1)), 
        aes(colour=workingday)) + 
  theme_grey(base_size = 5.6) + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5))
```
Fig.16 Column names in order: 
`dteday`, `weathersit`, `temp`, `atemp`, `windspeed`, `hum`, `cnt`

$$ $$
\newpage

$$\text{Fig.17: Pairs Plot for Group 1 (Colored by Holiday)}$$

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggpairs(data[c('dteday','weathersit','temp','atemp','windspeed','hum','cnt')], 
        progress = F, 
        lower = list(continuous = wrap("points", alpha = 0.3, size=0.1)), 
        aes(colour=holiday)) + 
  theme_grey(base_size = 5.6) + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5))
```
Fig.17 Column names in order: 
`dteday`, `weathersit`, `temp`, `atemp`, `windspeed`, `hum`, `cnt`


