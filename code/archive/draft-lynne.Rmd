---
title: "Model Drafts"
author: "Yulin Li"
date: "12/1/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE, include=FALSE}
# Load libraries
library(ggplot2)
library(GGally)
library(cowplot)
library(tidyverse)

# For ggplot, center all titles
theme_update(plot.title = element_text(hjust = 0.5))
```


```{r message=FALSE, warning=FALSE, include=FALSE}
# Read data
bikedata <- read.csv("../../data/bike-day.csv",header=T)
```

$$ $$

## Data Type & Value Conversion

```{r include=FALSE}
# Dates (from char to Date type)
dteday <- as.Date(bikedata$dteday)
```

Typically, all variables whose numerical values are not attached to actual physical meanings are treated as **categorical** variables.

```{r}
# Boolean variables (from int to logical type)
holiday <- as.logical(bikedata$holiday)          #0 or 1
workingday <- as.logical(bikedata$workingday)    #0 or 1

# Other categorical variables (from int to factor type)
season <- as.factor(bikedata$season)             #1 to 4
yr <- as.factor(bikedata$yr)                     #0 to 1
mnth <- as.factor(bikedata$mnth)                 #1 to 12
weekday <- as.factor(bikedata$weekday)           #0 to 6
weathersit <- as.factor(bikedata$weathersit)     #1 to 4
```

**Note:** Although `weathersit` (weather type) is a categorical variable, its numerical value (from 1 to 4) actually indicates a gradual change in the level of suitability for outdoor activities - the larger the number, the worse the weather condition (i.e., more fogs/rains/snows, see "Variable Interpretations" above). 

$$ $$

Furthermore, the normalized weather condition measurements (see "Variable Interpretations" above) are also converted to their original values, so that the numerical values being used "make more sense" to us. This makes it easier for commonsense and real-life experience to be applied in later analysis. 

```{r}
# Re-scale the normalized measurements
temp <- bikedata$temp * 41
atemp <- bikedata$atemp * 50
hum <- bikedata$hum * 100
windspeed <- bikedata$windspeed * 67 
```

$$ $$

## Visualization

```{r include=FALSE}
data <- bikedata[, c(14:16)]
data <- data.frame(dteday, season, yr, mnth, holiday, weekday, workingday,
                   weathersit, temp, atemp, hum, windspeed, data)

data2011 <- data[data$dteday < '2012-01-01', ]
data2012 <- data[data$dteday >= '2012-01-01', ]
```

$$ $$

### Pairwise Relationships

$$ $$

**Group 1: (Mainly) Environmental**

Predictors (all environmental variables plus date):

- `dteday` (date)
- `weathersit` (weather type)
- `temp` (measured temperature)
- `atemp` (feeling temperature)
- `windspeed` (wind speed)
- `hum` (humidity)

Response:

- `cnt` (daily total count)
- `registered` (daily registered count)
- `casual` (daily casual count)

$$ $$

**Group 2: Seasonal**

Predictors (all seasonal variables):

- `dteday` (date)
- `season` (season)
- `yr` (year)
- `mnth` (month)
- `holiday` (holiday or not)
- `weekday` (day of the week)
- `workingday` (working day or not)

Response:

- `cnt` (daily total count)
- `registered` (daily registered count)
- `casual` (daily casual count)

$$ $$

#### Pairs Plot for Group 1 (Mainly Environmental)

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggpairs(data[c('dteday','weathersit','temp','atemp','windspeed','hum','cnt')], 
        progress = F, 
        lower = list(continuous = wrap("points", alpha = 0.3, size=0.1))) + 
  theme_grey(base_size = 5.6) + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5))
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggpairs(data[c('dteday','weathersit','temp','atemp','windspeed','hum','registered')], 
        progress = F, 
        lower = list(continuous = wrap("points", alpha = 0.3, size=0.1))) + 
  theme_grey(base_size = 5.6) + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5))
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggpairs(data[c('dteday','weathersit','temp','atemp','windspeed','hum','casual')], 
        progress = F, 
        lower = list(continuous = wrap("points", alpha = 0.3, size=0.1))) + 
  theme_grey(base_size = 5.6) + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5))
```

#### Pairs Plot for Group 1 (Mainly Environmental) (Colored by Weather Type)

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggpairs(data[c('dteday','weathersit','temp','atemp','windspeed','hum','cnt')], 
        progress = F, 
        lower = list(continuous = wrap("points", alpha = 0.3, size=0.1)), 
        aes(colour=data[,'weathersit'])) + 
  theme_grey(base_size = 5.6) + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5))
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggpairs(data[c('dteday','weathersit','temp','atemp','windspeed','hum','registered')], 
        progress = F, 
        lower = list(continuous = wrap("points", alpha = 0.3, size=0.1)), 
        aes(colour=weathersit)) + 
  theme_grey(base_size = 5.6) + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5))
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggpairs(data[c('dteday','weathersit','temp','atemp','windspeed','hum','casual')], 
        progress = F, 
        lower = list(continuous = wrap("points", alpha = 0.3, size=0.1)), 
        aes(colour=weathersit)) + 
  theme_grey(base_size = 5.6) + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5))
```


#### Pairs Plot for Group 1 (Mainly Environmental) (Colored by Year)

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggpairs(data[c('dteday','weathersit','temp','atemp','windspeed','hum','cnt')], 
        progress = F, 
        lower = list(continuous = wrap("points", alpha = 0.3, size=0.1)), 
        aes(colour=yr)) + 
  theme_grey(base_size = 5.6) + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5))
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggpairs(data[c('dteday','weathersit','temp','atemp','windspeed','hum','registered')], 
        progress = F, 
        lower = list(continuous = wrap("points", alpha = 0.3, size=0.1)), 
        aes(colour=yr)) + 
  theme_grey(base_size = 5.6) + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5))
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggpairs(data[c('dteday','weathersit','temp','atemp','windspeed','hum','casual')], 
        progress = F, 
        lower = list(continuous = wrap("points", alpha = 0.3, size=0.1)), 
        aes(colour=yr)) + 
  theme_grey(base_size = 5.6) + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5))
```

#### Pairs Plot for Group 2 (Seasonal)


```{r echo=FALSE, message=FALSE, warning=FALSE}
ggpairs(data[c('dteday','season','yr','mnth','holiday','weekday','workingday', 'cnt')], 
        progress = F, 
        lower = list(continuous = wrap("points", alpha = 0.3, size=0.1))) + 
  theme_grey(base_size = 5.6) + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5))
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggpairs(data[c('dteday','season','yr','mnth','holiday','weekday','workingday', 'registered')], 
        progress = F, 
        lower = list(continuous = wrap("points", alpha = 0.3, size=0.1))) + 
  theme_grey(base_size = 5.6) + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5))
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggpairs(data[c('dteday','season','yr','mnth','holiday','weekday','workingday', 'casual')], 
        progress = F, 
        lower = list(continuous = wrap("points", alpha = 0.3, size=0.1))) + 
  theme_grey(base_size = 5.6) + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5))
```




## Modeling 

### Draft Model (for Comparison & Verification of Ideas)

Make a new variable: weekly average (a 7-day rolling average); presumably independent of the weekday offset.

```{r}
# mod

```

#### Trial 1

```{r}
# MLR Model 2: Quadratic in Temperature

m.mlr.2.cnt <- lm(cnt ~ yr + holiday + weathersit + atemp + I(atemp^2), data = data)
summary(m.mlr.2.cnt)

m.mlr.2.reg <- lm(registered ~ yr + holiday + weathersit + atemp + I(atemp^2), data = data)
summary(m.mlr.2.reg)

m.mlr.2.cas <- lm(casual ~ yr + holiday + weathersit + atemp + I(atemp^2), data = data)
summary(m.mlr.2.cas)
```
```{r}
summary(m.mlr.2.cnt)$coef[,"Estimate"]
summary(m.mlr.2.reg)$coef[,"Estimate"]
summary(m.mlr.2.cas)$coef[,"Estimate"]

# Yeaaah, so slitting response variable not meaningful if working with the same covariates
summary(m.mlr.2.reg)$coef[,"Estimate"] + summary(m.mlr.2.cas)$coef[,"Estimate"]
```

#### Trial 2

```{r}
# MLR Model 2: Quadratic in Temperature

m.mlr.2.cnt <- lm(cnt ~ yr + holiday + weathersit + atemp + I(atemp^2), data = data)
summary(m.mlr.2.cnt)

m.mlr.2.reg <- lm(registered ~ yr + holiday + weathersit + atemp + I(atemp^2), data = data)
summary(m.mlr.2.reg)

m.mlr.2.cas <- lm(casual ~ yr + weathersit + atemp + I(atemp^2), data = data)
summary(m.mlr.2.cas)
```

```{r}
summary(m.mlr.2.cnt)$coef[,"Estimate"]
summary(m.mlr.2.reg)$coef[,"Estimate"]
summary(m.mlr.2.cas)$coef[,"Estimate"]
```


```{r}
# 
summary(m.mlr.2.cnt)$coef[,"Estimate"][-3]
summary(m.mlr.2.reg)$coef[,"Estimate"][-3] + summary(m.mlr.2.cas)$coef[,"Estimate"]
```


```{r}
## Helper Functions

# 
# get_test_rmse = function(model, data) {
#   sqrt(mean((dat_tst$price - predict(model, newdata = dat_tst))^2))
# }
# 
# 
# get_perc_err = function(model) {
#   actual = dat_tst$price
#   predicted = predict(model, dat_tst)
#   100 * mean((abs(actual - predicted)) / actual)
# }


```


